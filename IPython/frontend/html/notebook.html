<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" /> 
        <title>AJAX test</title>
        <style type="text/css">
            .cblue { color: blue }
            .cgreen { color: green }
            .cred { color: red }
            .cbold { font-weight:bold }
        </style>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script type="text/javascript">
            client_id = "/$client_id";
            $.ajaxSetup({
                url: client_id,
                dataType: "json"
            })
            function fixConsole(txt) {
                //Fixes escaped console commands, IE colors. Turns them into HTML
                //Unfortunately, the "semantics" of html and console are very 
                //different, so fancy things *will* break
                var attrib = {"30":"cblack", "31":"cred","32":"cgreen", "34":"cblue", "01":"cbold"}
                //Must remove first \033[0m to eliminate pairing errors
                txt = txt.replace(/\033\[0m/, "")
                //Phase 1: substitute <span> for html
                var re = /\033\[([\d;]+?)m(.*?)\033\[0m/g
                txt = txt.replace(re, "<span class='[[$1]]'>$2</span>")
                //Phase 2: substitute class in span with correct attributes
                re = /\[\[([\d;]+?)\]\]/
                while (re.test(txt)) {
                    var match = re.exec(txt)
                    var cmds = match[1].split(";")
                    var reps = []
                    for (var j in cmds)
                        reps.push(attrib[cmds[j]])
                    txt = txt.replace( match[0], reps.join(" ") )
                }
                return txt
            }
            function comet() {
                $.ajax({
                    success: function(json, status, request) {
                        msg = json.msg_type+": "
                        if (json.msg_type == "stream")
                            msg += fixConsole(json.content.data)
                        else if (json.msg_type == "pyin")
                            msg += json.content.code
                        else if (json.msg_type == "pyout")
                            msg += json.content.data
                            
                        $("#messages").append("<pre>"+msg+"</pre>")
                        comet()
                    }
                })
            }
            function heartbeat() {
                $.ajax({
                    type: "POST",
                    data: {client_id:client_id, type:"heartbeat"},
                    success: function() {
                        setTimeout(heartbeat, 10000)
                    }
                })
            }
            function execute(code) {
                $.ajax({
                    type: "POST",
                    data: {type:"execute", code:code}
                })
            }
            $(document).ready(function() {
                comet()
                heartbeat()
                $("#exec").keypress(function(e) {
                    if (e.which == 13) {
                        execute(e.target.value)
                        e.target.value = ""
                    }
                })
            })
        </script>
    </head>
    <body>
        <div id="messages"></div>
        <input id="exec" style="width:100%" />
    </body>
</html>
